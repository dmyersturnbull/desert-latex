% Copyright 2022 Douglas Myers-Turnbull
% This work may be distributed and/or modified under the conditions of the LaTeX Project Public
% License, either version 1.3 of this license or (at your option) any later version. The latest
% version of this license is in http://www.latex-project.org/lppl.txt and version 1.3 or later is
% part of all distributions of LaTeX version 2005/12/01 or later.
%==================================================================================================


%=======                                                   =======
%=======               Nomenclature groups                 =======
%=======                                                   =======

% Note: Not compatible with nomencl's nomentbl option.

\NeedsTeXFormat {LaTeX2e} [2020-10-01]
\ExplSyntaxOn
\ProvidesExplPackage {nomgroups} {2022-02-08} {0.1} {Define~nomenclature~groups}
\RequirePackage[notocbasic]{nomencl}
\cs_generate_variant:Nn \int_max:nn { VV }

\prop_new:N \g_nomgroups_prop
\str_gset:Nn \g_nomgroups_text_str {Z}
\str_gset:Nn \g_nomgroups_math_str {Z}
\str_gset:Nn \g_nomgroups_unit_str {U}

\NewDocumentCommand \SetNomGroups {m}
    { \prop_gset_from_keyval:Nn \g_nomgroups_prop {#1} }

\NewDocumentCommand \AddDefaultNomGroups {}
    { \SetNomGroups{C=Constants,F=Functions,M=Sets,N=Sequences,U=Units,Z=Other~symbols} }

\NewDocumentCommand \AddNomGroups {m}
{
    \prop_set_from_keyval:Nn \l_tmpa_prop {#1}
    \prop_map_inline:Nn \l_tmpa_prop
        { \prop_put_if_new:Nnn \g_nomgroups_prop {##1} {##2} }
}

\NewDocumentCommand \UpdateNomGroups {m}
{
    \prop_set_from_keyval:Nn \l_tmpa_prop {#1}
    \prop_map_inline:Nn \l_tmpa_prop
        { \prop_put:Nnn \g_nomgroups_prop {##1} {##2} }
}

\skip_new:N \nomgroups_header_skip
\skip_gset:Nn \nomgroups_header_skip { 2ex plus 0.2ex minus 0.1ex }

\cs_new:Npn \nomgroups_format_header:n #1
    { \textbf{#1} }

\cs_new:Npn \nomgroups_make_header:n #1
{
    \skip_vertical:N \nomgroups_header_skip
    \item [ \hspace*{-\itemindent} \nomgroups_format_header:n{#1} ]
}

\keys_define:nn { nomgroups / setup}
{
    groups .code:n = { \SetNomGroups{#1} } ,
    groups .initial:n = {} ,
    add-default-groups .code:n = { \AddDefaultNomGroups } ,
    add-default-groups .default:n = true ,
    default-text-group .tl_gset:N = \g_nomgroups_text_str ,
    default-math-group .tl_gset:N = \g_nomgroups_math_str ,
    default-unit-group .tl_gset:N = \g_nomgroups_unit_str ,
    header-skip .skip_gset:N = \g_nomgroups_header_skip ,
    header-skip .initial:n = 1ex plus 0.1ex minus 0.025ex ,
    header-format .code:n = { \cs_gset_eq:Nc \nomgroups_format_header:n {#1} } ,  % in 2022+ use .cs_gset:N
}

\cs_new:Npn \nomgroups_setup:n #1
{
    \keys_set:nn {nomgroups / setup} {#1}
}
\NewDocumentCommand \NomGroupsSetup {m}
    { \nomgroups_setup:n{#1} }

\AtBeginDocument
{
    \renewcommand* {\nomgroup} [1]
    {
        \prop_map_inline:Nn \g_nomgroups_prop
        {
            \str_if_eq:nnT {##1} {#1}
                { \nomgroups_make_header:n{##2} }
        }
    }
}

\NewDocumentCommand \NomGroupLink { m m }
{
    \tl_if_blank:nTF {#1}
        { #2 }
        { \href{#1}{#2} }
}

\cs_new:Npn \nomgroups_make:vvnnnnn #1#2#3#4#5#6#7
{
    % careful! nomencl writes to a file
    \tl_if_blank:nTF {#2}
        { \nomenclature [#1,#3] {#7} {\NomGroupLink{#5}{#4 \hfill #6}} }
        { \nomenclature [#1,#2] {#7} {\NomGroupLink{#5}{#4 \hfill #6}} }
}

%\renewcommand \nomlabelwidth {\dim_use:N \g_desert_nom_symbol_dim}

\keys_define:nn { nomgroups / new }
{
    symbol .tl_set:N = \l__symbol_tl ,
    symbol .initial:n = {} ,
    text .tl_set:N = \l__text_tl ,
    text .initial:n = {} ,
    group .tl_set:N = \l__group_tl ,
    group .initial:n = {} ,
    sort .tl_set:N = \l__sort_tl ,
    sort .initial:n = {} ,
    url .tl_set:N = \l__url_tl ,
    url .initial:n = {} ,
    value .tl_set:N = \l__value_tl ,
    value .initial:n = {} ,
}

\NewDocumentCommand \NewNom { m }
{
    \group_begin:
    \keys_set:nn {nomgroups / new} {#1}
    \nomgroups_make:vvnnnnn
        {\l__group_tl}
        {\l__sort_tl}
        {\l__symbol_tl}
        {\l__text_tl}
        {\l__url_tl}
        {\l__value_tl}
        {\l__symbol_tl}
    \group_end:
}

\NewDocumentCommand \NomText
{
    >{\TrimSpaces}D(){\g_nomgroups_text_str} % 1 group
    >{\TrimSpaces}O{}                        % 2 optional sort key
    >{\TrimSpaces}m                          % 3 symbol
    >{\TrimSpaces}m                          % 4 description
    >{\TrimSpaces}D<>{}                      % 5 optional URL
    >{\TrimSpaces}O{}                        % 6 optional value on right
}
{
    \nomgroups_make:vvnnnnn{#1}{#2}{#3}{#4}{#5}{#6}{#3}
}

\NewDocumentCommand \NomMath
{
    >{\TrimSpaces}D(){\g_nomgroups_math_str} % 1 group
    >{\TrimSpaces}O{}                        % 2 optional sort key
    >{\TrimSpaces}m                          % 3 symbol
    >{\TrimSpaces}m                          % 4 description
    >{\TrimSpaces}D<>{}                      % 5 optional URL
    >{\TrimSpaces}O{}                        % 6 optional value on right
}
{
    \nomgroups_make:vvnnnnn{#1}{#2}{#3}{#4}{#5}{#6}{\ensuremath{#3}}
}

\NewDocumentCommand \NomUnit
{
    >{\TrimSpaces}D(){\g_nomgroups_unit_str} % 1 group
    >{\TrimSpaces}O{}                        % 2 optional sort key
    >{\TrimSpaces}m                          % 3 symbol
    >{\TrimSpaces}m                          % 4 description
    >{\TrimSpaces}D<>{}                      % 5 optional URL
    >{\TrimSpaces}O{}                        % 6 optional value on right
}
{
    \nomgroups_make:vvnnnnn{#1}{#2}{#3}{#4}{#5}{#6}{\unit{#3}}
}
